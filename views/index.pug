extends layout

block content
    if user
        ul#messages
        form#msg-field(action="")
            p#typing
            .form-group
                .input-group
                    input#m(type="text" autocomplete="off" placeholder="...").form-control
                    span.input-group-btn
                        button(type="submit").btn.btn-secondary Send
    else
        div.jumbotron
            h1 Chat App
            p
                a(href="/signin" role="button").btn.btn-primary.btn-lg Sign in!
                    span.glyphicon.glyphicon-user
  
    script(src="/socket.io/socket.io.js").
    script(src="http://code.jquery.com/jquery-1.11.1.js").
    script.
        var socket = io();
        var user = !{JSON.stringify(user)};
        var typing = [];
        
        // constructs the "users typing..." string based on the user names in the typing array
        function setUsersTyping() {
            var indicitive = " is ";
            if (typing.length == 0) $('#typing').text('');
            else if (typing.length == 1) $('#typing').text(typing[0] + indicitive + "typing...");
            else {
                indicitive = " are ";
                var typers = "";
                var num = Math.min(typing.length, 5);
                for (var i = 0; i < num; i++) {
                    typers += typing[i] + (i < num - 1 ? ", " : "");
                }
                $('#typing').text(typers + indicitive + "typing...");
            }
        }
        
        $('#msg-field').on('submit', function() {
            socket.emit('chat message', user, $('#m').val());
            $('#m').val('');
            return false;
        });

        $('#m').on('change paste keyup', function() {
            // there are characters in the input field
            if ($(this).val() != '') {
                // if I'm not already registered as typing
                if (typing.indexOf(user.username) == -1) {
                    socket.emit('user typing', user.username);
                }
            } else {
                // if I'm registered as typing
                if (typing.indexOf(user.username) > -1) {
                    socket.emit('done typing', user.username);
                }
            }
            return false;
        });

        // NOTE: A user's message should be posted directly to their
        // message list, rather than receiving it through the chat message event.
        socket.on('chat message', function(user, msg) {
            $('#messages').append($('<li>').text(user.username + ": " + msg));
        });
        
        socket.on('user typing', function(username) {
            typing.push(username);
            setUsersTyping();
        });
        
        socket.on('done typing', function(username) {
            var index = typing.indexOf(username);
            if (index > -1) typing.splice(index, 1);
            setUsersTyping();
        });
        